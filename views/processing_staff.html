<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>参与员工</title>
    <!-- Bootstrap core CSS -->
    <link href="/public/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .btn-group-lg>.btn, .btn-lg{
        font-size:3rem;
        width:180px;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>
    <!-- Custom styles for this template -->
    <link href="/public/css/dashboard.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="#">忘年会</a>
  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-toggle="collapse" data-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <ul class="navbar-nav px-3">
    <li class="nav-item text-nowrap">
      <a class="nav-link" href="/login/">Sign out</a>
    </li>
  </ul>
</nav>

<div class="container-fluid">
  <div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="sidebar-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/config/index/">
              Dashboard 
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/config/index/">
              当前活动
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/config/processing_staff/">
              参与员工 <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/config/staffs/">
              社员管理
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/config/system/">
              系统管理
            </a>
          </li>
        </ul>
        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>抽奖界面</span>
        </h6>
        <ul class="nav flex-column mb-2">
          <li class="nav-item">
            <a class="nav-link" target="_blank" href="/config/lottery_ohs/">
              上海
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" target="_blank" href="/config/lottery_jhg/">
              南通
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" target="_blank" href="/config/lottery/">
              返场奖
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" target="_blank" href="/config/lottery_viewer/">
              参加人数仪表
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
    <div id="alert" class="alert">
    </div>
    <div id="btnProcessingNumber" class="btn-group my-2">
        <button type="button" value="0" class="btn btn-light">测试奖</button>
        <button type="button" value="1" class="btn btn-light">1</button>
        <button type="button" value="2" class="btn btn-light">2</button>
        <button type="button" value="3" class="btn btn-light">3</button>
        <button type="button" value="4" class="btn btn-light">4</button>
        <button type="button" value="5" class="btn btn-light">5</button>
        <button type="button" value="6" class="btn btn-light">6</button>
        <button type="button" value="7" class="btn btn-light">7</button>
        <button type="button" value="8" class="btn btn-light">8</button>
        <button type="button" value="9" class="btn btn-light">9</button>
        <button type="button" value="10" class="btn btn-light">10</button>
        <button type="button" value="11" class="btn btn-light">11</button>
        <button type="button" value="12" class="btn btn-light">12</button>
        <button type="button" value="13" class="btn btn-light">一等</button>
        <button type="button" value="14" class="btn btn-light">一等</button>
        <button type="button" value="15" class="btn btn-light">神秘</button>
    </div>
    <h1 class="h2">入围员工</h1>
    <div class="row my-4">
    <div class="col-6">
    <button id="btnSetWinnerOHS" class="btn btn-primary">设定获奖者</button>
    <table id="tblShootingStaffOHS" class="table table-striped table-hover table-sm mt-4" style="font-size:1.5rem">
        <thead>
        <tr>
            <th></th>
            <th>#</th>
            <th>员工号</th>
            <th>姓名</th>
            <th>头像</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    </div>
    <div class="col-6">
    <button id="btnSetWinnerJHG" class="btn btn-primary">设定获奖者</button>
    <table id="tblShootingStaffJHG" class="table table-striped table-hover table-sm mt-4" style="font-size:1.5rem">
        <thead>
        <tr>
            <th></th>
            <th>#</th>
            <th>员工号</th>
            <th>姓名</th>
            <th>头像</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    </div>
    </div>
    <h1 class="h2">参与员工</h1>
    <div class="row my-4">
    <div class="col-6">
    <div class="input-group mb-3">
      <input id="txtStaffNoOHS" type="text" class="form-control" placeholder="员工号">
      <div class="input-group-append">
        <button id="btnAddOHS" class="btn btn-primary mr-4" type="button">添加</button>
      </div>
      <button id="btnDelOHS" class="btn btn-danger">删除</button>
    </div>
    <table id="tblProceesingStaffOHS" class="table table-striped table-hover table-sm">
        <thead>
        <tr>
            <th></th>
            <th>#</th>
            <th>员工号</th>
            <th>姓名</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    </div>
    <div class="col-6">
    <div class="input-group mb-3">
      <input id="txtStaffNoJHG" type="text" class="form-control" placeholder="员工号">
      <div class="input-group-append">
        <button id="btnAddJHG" class="btn btn-primary mr-4" type="button">添加</button>
      </div>
      <button id="btnDelJHG" class="btn btn-danger">删除</button>
    </div>
    <table id="tblProceesingStaffJHG" class="table table-striped table-hover table-sm">
        <thead>
        <tr>
            <th></th>
            <th>#</th>
            <th>员工号</th>
            <th>姓名</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    </div>
    </div>
    </main>
  </div>
</div>
<div id="my-messagebox" class="modal" style="z-index:9999;display: none;" >  
      <div class="modal-dialog  modal-dialog-centered">  
        <div class="modal-content">
          <div class="modal-body">
           <div class="row mt-4">
                <div class="col-10"><p style="line-height:40px;height:40px;overflow:hidden;">[Message]</p></div>
           </div>
          </div>  
          <div class="text-center mx-auto mb-3" >  
            <button type="button" class="btn btn-primary ok" data-dismiss="modal">[BtnOk]</button>  
            <button type="button" class="btn btn-default cancel" data-dismiss="modal">[BtnCancel]</button>  
          </div>  
        </div>  
      </div>  
</div>
</body>
<script src="/public/js/jquery-3.4.1.min.js"></script>
<script src="/public/js/ajax-form.js"></script>
<script src="/public/js/bootstrap.min.js"></script>
<script src="/public/js/prettify-min.js"></script>
<script src="/public/js/common.js"></script>
<script>
  var processing_number_current = 0;

  $("#btnProcessingNumber button").click(function(){
        $("#btnProcessingNumber button").removeClass("btn-dark").addClass("btn-light");
        $(this).removeClass("btn-light").addClass("btn-dark");
        var processing_number = Number($(this).val());
        if(processing_number == processing_number_current){
        $(this).addClass("btn-lg");
          $("#btnSetWinnerOHS").removeAttr("disabled");
          $("#btnSetWinnerJHG").removeAttr("disabled");
          $("#btnAddOHS").removeAttr("disabled");
          $("#btnAddJHG").removeAttr("disabled");
          $("#btnDelOHS").removeAttr("disabled");
          $("#btnDelJHG").removeAttr("disabled");
        }
        else{
          $("#btnSetWinnerOHS").attr("disabled","true");
          $("#btnSetWinnerJHG").attr("disabled","true");
          $("#btnAddOHS").attr("disabled","true");
          $("#btnAddJHG").attr("disabled","true");
          $("#btnDelOHS").attr("disabled","true");
          $("#btnDelJHG").attr("disabled","true");
        }

        let param = {};
        
        param['processing_number'] = processing_number;
        param['company'] = 'OHS';
        getJSON('shooting_staff/', param).done(function (data) {
            var html = "";
            for(var i=0;i<data.length;i++){
                if(data[i].winning){
                  html = html +  "<tr class='table-success'>";
                }
                else{
                  html = html +  "<tr>";
                }
                html = html +  "<td><input type='checkbox' id='" + data[i].staff_id + "'></td>";
                html = html +  "<td>" + (i+1) + "</td>";
                html = html +  "<td>" + data[i].staff_id + "</td>";
                html = html +  "<td>" + data[i].name + "</td>";
                html = html +  "<td>"
                html = html +  "<image src='" + makeAvatarFromName(data[i].name) + "' width='40px' >"
                html = html +  "</td>";
                html = html +  "</tr>";
            }
            $("#tblShootingStaffOHS tbody").html(html);
        })
        .fail(function (response, status) {
            //handle error response
        })
        .always(function(){
            //do something useful in either case
        });

        getJSON('processing_staff/', param).done(function (data) {
            var html = "";
            for(var i=0;i<data.length;i++){
                html = html +  "<tr>";
                html = html +  "<td><input type='checkbox' id='" + data[i].staff_id + "'></td>";
                html = html +  "<td>" + (i+1) + "</td>";
                html = html +  "<td>" + data[i].staff_id + "</td>";
                html = html +  "<td>" + data[i].name + "</td>";
                html = html +  "</tr>";
            }
            $("#tblProceesingStaffOHS tbody").html(html);
        })
        .fail(function (response, status) {
            //handle error response
        })
        .always(function(){
            //do something useful in either case
        });

        param['company'] = 'JHG';

        getJSON('shooting_staff/', param).done(function (data) {
            var html = "";
            for(var i=0;i<data.length;i++){
                if(data[i].winning){
                  html = html +  "<tr class='table-success'>";
                }
                else{
                  html = html +  "<tr>";
                }
                html = html +  "<td><input type='checkbox' id='" + data[i].staff_id + "'></td>";
                html = html +  "<td>" + (i+1) + "</td>";
                html = html +  "<td>" + data[i].staff_id + "</td>";
                html = html +  "<td>" + data[i].name + "</td>";
                html = html +  "<td>"
                if(data[i].avatar!==""){
                    html = html +  "<image src='" + data[i].avatar + "' width='40px' >"
                }
                html = html +  "</td>";
                html = html +  "</tr>";
            }
            $("#tblShootingStaffJHG tbody").html(html);
        })
        .fail(function (response, status) {
            //handle error response
        })
        .always(function(){
            //do something useful in either case
        });

        if(processing_number>14) {
            $("#tblProceesingStaffJHG tbody").html("");
            $("#tblProceesingStaffJHG").css("display","none");
            $("#txtStaffNoJHG").css("display","none");
            $("#btnAddJHG").css("display","none");
            $("#btnDelJHG").css("display","none");
            return;
        }
        else{
            $("#tblProceesingStaffJHG").css("display","table");
            $("#txtStaffNoJHG").css("display","block");
            $("#btnAddJHG").css("display","block");
            $("#btnDelJHG").css("display","block");
        }

        getJSON('processing_staff/', param).done(function (data) {
            var html = "";
            for(var i=0;i<data.length;i++){
                html = html +  "<tr>";
                html = html +  "<td><input type='checkbox' id='" + data[i].staff_id + "'></td>";
                html = html +  "<td>" + (i+1) + "</td>";
                html = html +  "<td>" + data[i].staff_id + "</td>";
                html = html +  "<td>" + data[i].name + "</td>";
                html = html +  "</tr>";
            }
            $("#tblProceesingStaffJHG tbody").html(html);
        })
        .fail(function (response, status) {
            //handle error response
        })
        .always(function(){
            //do something useful in either case
        });
  })
  getJSON('activity/').done(function (data) {
      var processing_number = data.processing_number;
      if(processing_number>15) processing_number =15;
      processing_number_current = processing_number;
      $("#btnProcessingNumber button")[processing_number].click();
  })

  $("#btnSetWinnerOHS").click(function(){
    console.log('btnSetWinnerOHS clicked');
    messageBox.confirm("确认设置获奖者？",setWinnerOHS);
  })

  function setWinnerOHS(){
    var winningStaffNo = $("#tblShootingStaffOHS input[type='checkbox']");
    var staffs  = new Array();
    for(var i=0;i< winningStaffNo.length;i++){
      if(winningStaffNo[i].checked){
        staffs = staffs.concat(winningStaffNo[i].id)
      }
    }
    if(staffs.length==1){

    }
    else if(staffs.length>1){
      if(processing_number_current<=14){
        messageBox.alert('只能设定一位获奖者。');
        return;
      }
    }
    else{
      messageBox.alert('请指定获奖者。');
      return;
    }

    postJSON('winning_staff',
                { processing_number:processing_number_current,
                  company:'OHS',
                  staffs: staffs
                }).done(function (data) {
                  if(data.success){
                    $("#btnProcessingNumber button")[processing_number_current].click();
                  }
    });
  }

  $("#btnAddOHS").click(function(){
    console.log('btnAddOHS clicked');
    if($("#txtStaffNoOHS").val()!==''){
      postJSON('processing_staff',
                { processing_number:processing_number_current,
                  company:'OHS',
                  staff_id:$("#txtStaffNoOHS").val()
                }).done(function (data) {
                  if(data.success){
                    $("#btnProcessingNumber button")[processing_number_current].click();
                    messageBox.alert("添加成功！");
                  }
        });
    }
  })

  $("#btnDelOHS").click(function(){
    console.log('btnDelOHS clicked');
    
    messageBox.confirm("是否要删除选中的参与员工？",deleteOHS);


  })

  function deleteOHS(){
    var deletingStaffNo = $("#tblProceesingStaffOHS input[type='checkbox']");
    var staffs = new Array();
    for(var i=0;i< deletingStaffNo.length;i++){
      if(deletingStaffNo[i].checked){
        staffs = staffs.concat(deletingStaffNo[i].id)
      }
    }

    if(staffs.length>0){
      postJSON('delete_processing_staff',
                { processing_number:processing_number_current,
                  company:'OHS',
                  staffs: staffs
                }).done(function (data) {
                  if(data.success){
                    $("#btnProcessingNumber button")[processing_number_current].click();
                    messageBox.alert("删除成功！");
                  }
        });
    }
  }

  $("#btnSetWinnerJHG").click(function(){
    console.log('btnSetWinnerJHG clicked');

    messageBox.confirm("确认设置获奖者？",setWinnerJHG);
  })

  function setWinnerJHG(){
    var winningStaffNo = $("#tblShootingStaffJHG input[type='checkbox']");
    var staffs  = new Array();
    for(var i=0;i< winningStaffNo.length;i++){
      if(winningStaffNo[i].checked){
        staffs = staffs.concat(winningStaffNo[i].id)
      }
    }
    if(staffs.length==1){

    }
    else if(staffs.length>1){
      if(processing_number_current<=14){
        messageBox.alert('只能设定一位获奖者。');
        return;
      }
    }
    else{
      messageBox.alert('请指定获奖者。');
      return;
    }

    postJSON('winning_staff',
                { processing_number:processing_number_current,
                  company:'JHG',
                  staffs: staffs
                }).done(function (data) {
                  if(data.success){
                    $("#btnProcessingNumber button")[processing_number_current].click();
                  }
    });
  }

  $("#btnAddJHG").click(function(){
    console.log('btnAddJHG clicked');
    if($("#txtStaffNoJHG").val()!==''){
      postJSON('processing_staff',
                { processing_number:processing_number_current,
                  company:'JHG',
                  staff_id:$("#txtStaffNoJHG").val()
                }).done(function (data) {
                  if(data.success){
                    $("#btnProcessingNumber button")[processing_number_current].click();
                    messageBox.alert("添加成功！");
                  }
        });
    }
  })

  $("#btnDelJHG").click(function(){
    console.log('btnDelJHG clicked');

    messageBox.confirm("是否要删除选中的参与员工？",deleteJHG);
  })

  function deleteJHG(){
    var deletingStaffNo = $("#tblProceesingStaffJHG input[type='checkbox']");
    var staffs = new Array();
    for(var i=0;i< deletingStaffNo.length;i++){
      if(deletingStaffNo[i].checked){
        staffs = staffs.concat(deletingStaffNo[i].id)
      }
    }

    if(staffs.length>0){
      postJSON('delete_processing_staff',
                { processing_number:processing_number_current,
                  company:'JHG',
                  staffs: staffs
                }).done(function (data) {
                  if(data.success){
                    $("#btnProcessingNumber button")[processing_number_current].click();
                    messageBox.alert("删除成功！");
                  }
        });
    }
  }

</script>
</html>